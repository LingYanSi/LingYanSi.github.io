<!doctype html>
<html lang="en">
 <head>
   <meta charset="UTF-8">
  <meta name="Generator" content="EditPlus®">
  <meta name="Author" content="">
  <meta name="Keywords" content="">
  <meta name="Description" content="声音碎片，闭眼听世界">
   <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport" />
   <link rel="shorcut icon" href="img/icon.jpg" />
  <title>声音碎片</title>
  <link rel="stylesheet" href="css/global.css" />
  <style type="text/css">
	  .special{width:100%;overflow:hidden;}
	  .sp_item{width:200px;height:300px;background:#fff;display:inline-block;float:left;position:relative;}
	  .sp_item a{display:block;height:100%;width:100%;text-decoration:none;}
	  .sp_item_img{width:200px;height:200px;overflow:hidden;}
	  .sp_item_img img{height:100%;width:100%;}
	  .sp_item_title{height:40px;line-height:40px;font-size:18px;}
	  .sp_item_content{height:50px;}

	  
	  .sii_img img{height:100%;width:100%;}
	  
	  .sp_item_new{overflow:hidden;}
	  .sin_img,.sin_txt{position:relative;width:200px;height:200px;display:inline-block;float:left;border:1px solid gray;}
	  .sin_img:hover{cursor:default;}
	  .sin_txt{width:300px;margin-left:8px;border:0;}
	  .file{display:none;}
	  .sii_img{position:absolute;height:100%;width:100%;display:none;}
	  .sii_butt{position:absolute;height:100%;width:100%;text-align:center;line-height:200px;}
	  
	  .sp_item_new input{outline:none;width:100%;height:25px;border:1px solid gray;padding:0 4px;}
	  .sp_item_new input:focus{border:1px solid gray;}
	  .sin_title,.sin_url,.sin_content{width:100%;}
	  .sin_title input{width:50%;}
	  .sin_txt_item + .sin_txt_item{margin-top:8px;}

	  .sin_butt{margin-top:8px;}
	  .div_butt{display:inline-block;height:30px;width:50px;line-height:30px;text-align:center;cursor:pointer;}
	  .append{background:#FFC0CB;}
	  .cancel{background:#AFEEEE;}

	  .edit{background:#FFC0CB;}
	  .edit_cancel{background:#AFEEEE;display:none;}
	  .edit_delete{background:#F0FFFF;display:none;}

	  .sp_item_pgd{position:absolute;top:0;left:0;height:100%;width:100%;background:red;opacity:0.3;}
	  .sp_item_pgd_edit{background:#000;}
  </style>
 </head>

 <body>
	<div class="nav" id="div">
		<div class="nav_content">
			<div class="nav_item nav_left" onclick=''><a href="../ama/">西厢</a></div>
			<div class="nav_item nav_left"><a href="../mtime/">时光</a></div>
			<div class="nav_item nav_left"><a href="../special/">旋转</a></div>
			<div class="nav_item nav_right nav_login" id='nav_login'><a href="login.html">登录</a></div>
			<div class="nav_item nav_right nav_center" id='nav_center'><div id="" class="nav_center_box">
				<li class="nav_center_item nav_center_name">灵岩</li>
				<li class="nav_center_item nav_center_home"><a href="per-info.html">我的主页</a></li>
				<li class="nav_center_item nav_center_nwes"><a href="news.html">消息</a></li>
				<li class="nav_center_item nav_center_quit">退出</li>
			</div></div>
		</div>
	</div>
	<div id="" class="main">
		<div id="special" class="special">
			<!-- <div id="" class="sp_item">
				<div class='sp_item_img'><img src="img/logo.jpg" alt="" /></div>
				<div class='sp_item_title'>音乐播放器</div>
				<div class='sp_item_content'>兼容PC、移动端</div>
			</div> -->
		</div>
		<div id="" class="" style='border:2px solid gray;padding:15px;'>
			<div id="" class="sp_item_new" id="sp_item_new">
				<div class="sin_img">
					<input type="file" name="file" id="file" class="file">
					<div id="sii_img" class="sii_img"><img src="" alt="" /></div>
					<div id="sii_butt" class="sii_butt">点击添加图片</div>
				</div>
				<div id="" class="sin_txt">
					<div class="sin_title sin_txt_item" id="sin_title"><input type="text" placeholder="名称"></div>
					<div class="sin_url sin_txt_item" id="sin_url"><input type="text" placeholder="链接"></div>
					<div class="sin_content sin_txt_item" id="sin_content"><input type="text" placeholder="添加一点描述"></div>
					<div id="sin_butt" class="sin_butt">
						<div id="cancel" class="cancel div_butt">
							取消
						</div>
						<div id="append" class="append div_butt">
							提交
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="edit_bar" class="edit_bar" style="position:fixed;width:50px;top:60px;margin-left:-50px;">
			<div id="edit" class="edit div_butt">
				编辑
			</div>
			<div id="edit_delete" class="edit_delete div_butt">
				删除
			</div>
			<div id="edit_cancel" class="edit_cancel div_butt">
				取消
			</div>
		</div>
	</div>
 <script type="text/javascript"src="js/jquery-1.9.0.min.js"></script> 
  <script type="text/javascript"src="js/check.js"></script> 
 <script type="text/javascript"src="js/ajaxfileupload.js"></script>  
 <script type="text/javascript">
	$(function(){
		$('#edit').click(function(){$(this).hide().siblings().show();});
		$('#edit_cancel').click(function(){$(this).hide().prev().hide().prev().show();})
		$.ajax({ 
                async: true, 
                url: "get.php", 
                type: "post", 
                dataType: 'json',
                jsonp: 'jsoncallback', 
                data: null, 
                //contentType: "application/json;utf-8", 
                success:function (data, textStatus){
					var info = data ;
					for (i=0;i<info.length ;i++ )
					{
						$("#special").prepend('<div id="" class="sp_item"><a target="_blank" href="'+info[i].href+'"><div class="sp_item_img"><img src="'+info[i].img_add+'" alt="" /></div><div class="sp_item_title">'+info[i].title+'</div><div class="sp_item_content">'+info[i].content+'</div></a></div>');
					}
				}, 
                error: function (jqXHR, textStatus, errorThrown) { 
                    alert('第一错误'); 
                } 
          });
		$('#append').click(function(){
			if (document.getElementById('file').files.length==1 && $("#sin_url input").val().length>0 && $("#sin_title input").val().length>0 && $("#sin_content input").val().length>0)
			{
				$.ajaxFileUpload({
					url: 'upload.php', 
					type: 'post',
					secureuri: false, //一般设置为false，
					fileElementId: 'file', // 上传文件的id、name属性名
					dataType: 'json', //返回值类型，一般设置为json、application/json
					elementIds: null, //传递参数到服务器
					success: function(data, status){  
						var pos = data.pos
						$.ajax({ 
							async: true, 
							url: "write.php", 
							type: "post", 
							dataType: 'json',
							jsonp: 'jsoncallback', 
							data: {add:pos,href:$("#sin_url input").val(),title:$("#sin_title input").val(),content:$("#sin_content input").val()}, 
							//contentType: "application/json;utf-8", 
							success:function (data, textStatus){
								$("#special").prepend('<div id="" class="sp_item"><a target="_blank" href="'+$("#sin_url input").val()+'"><div class="sp_item_img"><img src="'+pos+'" alt="" /></div><div class="sp_item_title">'+$("#sin_title input").val()+'</div><div class="sp_item_content">'+$("#sin_content input").val()+'</div></a></div>');
								
								$("#sin_url>input,#sin_title>input,#sin_content>input").val('');
								$('#sii_img').hide();
								$('#sii_img img').attr({'src':''});
								$('#sii_butt').css({'height':200,'width':200,'line-height':'200px','background':'#fff','opacity':1});
								$('#sii_butt').text("点击添加图片");
							}, 
							error: function (jqXHR, textStatus, errorThrown) { 
								alert('第一错误'); 
							} 
					  });
						
					},
					error: function(data, status, e){ 
						alert('上传出现错误');
					}
				});
				
			}
			else{alert('有一些错误')}
		});
		$('#sii_butt').click(function(){
			document.getElementById('file').click();
		});
		$(".sin_img").on('change','#file',function(){
			var f = document.getElementById('file').files[0];
			var url = window.URL.createObjectURL(f);
			if (url)//验证是否有图片被选中，如若没有则不替换原来的地址
			{
				$('#sii_img img').attr({'src':url});
				$('#sii_img').show();
				$('#sii_butt').css({'height':50,'width':50,'line-height':'50px','background':'#fff','opacity':0.3});
				$('#sii_butt').text("换一张");
			}
			else{
				$('#sii_img img').attr({'src':''});
				$('#sii_butt').css({'height':200,'width':200,'line-height':'200px','background':'#fff','opacity':1});
				$('#sii_butt').text("点击添加图片");
			}
		});
		$("#cancel").click(function(){
			$("#sin_url>input,#sin_title>input,#sin_content>input").val('');
			$('#sii_img').hide();
			$('#sii_img img').attr({'src':''});
			$('#sii_butt').css({'height':200,'width':200,'line-height':'200px','background':'#fff','opacity':1});
			$('#sii_butt').text("点击添加图片");
		});
		
		var edit=false;
		$("#edit").click(function(){
			if (!edit)
			{
				$(".sp_item").append('<div class="sp_item_pgd"></div>');
				edit=true;
			}
		});
		$("#edit_cancel").click(function(){
			if (edit)
			{
				$(".sp_item .sp_item_pgd").remove();
				$(".sp_item").removeClass('sp_item_sel');//给被选中的item，移除标示class
				edit=false;
			}
		});
		$("#edit_delete").click(function(){ //删除事件
			if (if_login)
			{
				if (edit && $('.sp_item_sel').length>0)//是否开启删除事件，是否有元素被选中
				{
					var sis_index_delete='' ;
					var sp_item_len = $('.sp_item').length ;
					$('.sp_item_sel').each(function(){
						sis_index_delete = sis_index_delete+(sp_item_len-$(this).index()-1)+'_';//将被删除的元素的位置叠加成一个字符串，以便传输
					});
					$.ajax({ //ajax请求服务器删除
						async: false, 
						url: "delete.php", 
						type: "post", 
						dataType: 'json',
						jsonp: 'jsoncallback', 
						data: {pos:sis_index_delete}, 
						//contentType: "application/json;utf-8", 
						success:function (data, textStatus){
							$('.sp_item_sel').remove();//服务器删除成功后，删除本地被选中的元素
						}, 
						error: function (jqXHR, textStatus, errorThrown) { 
							alert('删除失败'); 
						} 
				  });
				}
				else if (edit && $('.sp_item_sel').length==0)
				{
					alert("请至少选中一个元素")
				}
			}
			else{alert("请登录")}
		});
		$("#special").on('click','.sp_item',function(){//给js添加的元素一个激活事件
			if (edit)
			{
				if ($(this).find(".sp_item_pgd").hasClass('sp_item_pgd_edit'))
				{
					$(this).removeClass('sp_item_sel').find(".sp_item_pgd").removeClass('sp_item_pgd_edit');//给被选中的item，移除标示class
				}
				else 
				{
					$(this).addClass('sp_item_sel').find(".sp_item_pgd").addClass('sp_item_pgd_edit');//给被选中的item，添加一个标示class
				}
			}
		});
	})
	
 </script>
 </body>
</html>
