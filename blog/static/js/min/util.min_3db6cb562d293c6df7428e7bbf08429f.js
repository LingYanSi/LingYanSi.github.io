"use strict";var _slicedToArray=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(u){o=!0,i=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),__fetch=function(t){var e="__ajax_cache__",n={store:function(){var t=sessionStorage.getItem(e)||"{}";return JSON.parse(t)}(),get:function(t){return this.store[t]||""},set:function(t,n){this.store[t]=n,sessionStorage.setItem(e,JSON.stringify(this.store))}},r=function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];e.method=e.method||"GET",e.body=e.body||"";var r=[t,e.method,e.body].join("__wpt_ajax__");return new Promise(function(o){var i=new XMLHttpRequest,a={OK:!1,origin:void 0,json:function(){var t=this;return new Promise(function(e,n){e(JSON.parse(t.origin))})},text:function(){var t=this;return new Promise(function(e,n){e(new String(t.origin))})}};if(e.asynRequest&&!e.asynRequest.cached)return e.asynRequest.cached=!0,a.OK=!0,a.fromCache=!0,a.origin=n.get(r),console.log("数据从缓存中获取"),a.origin&&o(a),console.log("从服务器拉取"),void e.asynRequest.call(e.context);e.asynRequest&&(e.asynRequest.cached=!1),i.addEventListener("progress",function(t){e.progress&&e.progress(t.loaded/t.total)},!1),i.addEventListener("abort",function(t){o(a)},!1),i.addEventListener("error",function(t){o(a)},!1),i.addEventListener("load",function(t){},!1),i.upload.onprogress=function(t){e.uploadProgress&&e.uploadProgress(t.loaded/t.total)},i.open(e.method,t,!0),e.contentType&&i.setRequestHeader("Content-Type",e.contentType);var s=e.body;i.responseType="text",i.addEventListener("readystatechange",function(t){4==i.readyState&&(a.OK=200==i.status,a.origin=i.responseText,200==i.status&&e.asynRequest&&n.set(r,a.origin),o(a))}),i.send(s)})};return r.origin=t,r}(window.fetch),Queue=function(t){var e=arguments.length<=1||void 0===arguments[1]?0:arguments[1];this.queue=[],this.fn=t;var n=this;this.tick=function(){this.queue.forEach(clearTimeout),this.queue.push(setTimeout(function(){requestAnimationFrame?requestAnimationFrame(function(){n.fn()}):n.fn()},e))}},Utils={time:{toString:function(t){var e=new Date((+t));return e.getFullYear()+"-"+this.fillZero(e.getMonth()+1)+"-"+this.fillZero(e.getDate())+" "+this.fillZero(e.getHours())+":"+this.fillZero(e.getMinutes())+":"+this.fillZero(e.getSeconds())},fillZero:function(t){return t<10?"0"+t:""+t}},lastPosition:{set:function(t,e){var n=Utils.getSessionStorage("lastPosition");n[t]=e,Utils.setSessionStorage("lastPosition",n)},get:function(t){var e=Utils.getSessionStorage("lastPosition"),n=e[t]||{};return n}},getSessionStorage:function(t){var e=window.sessionStorage.getItem(t)||"{}";try{e=JSON.parse(e)}catch(n){e={}}return e},setSessionStorage:function(t,e){window.sessionStorage.setItem(t,JSON.stringify(e))},scroll:function(){var t={},e=function(){for(var e in t)t[e]&&t[e]()},n=new Queue(e,50);window.addEventListener("scroll",function(){n.tick()});var r={listen:function(e,n){return t[e]=n,{detory:function(){r.remove(e)},key:e}},remove:function(e){delete t[e]},trigger:e,tick:n.tick.bind(n)};return r}(),getImageCDNSrc:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=document.createElement("a");n.href=t,t=n.pathname,n=null,e=this.assign({q:75,format:Utils.__webp_surport__?"webp":""},e);var r=Object.keys(e).map(function(t){return e[t]?"/"+t+"/"+e[t]:""}).reduce(function(t,e){return t+e});return this.CDN.qiniu+t+"?imageView2/2"+r},assign:function(){for(var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return n.forEach(function(e){for(var n in e)t[n]=e[n]}),t},CDN:function(){var t=function n(){var t=Math.round(Math.random()*e);return t=Math.max(t,0),n.all[t]};t.qiniu="http://o9fl7r0ix.bkt.clouddn.com",t.all=[t.qiniu];var e=t.all.length-1;return t}(),loadImageUtil:{data:function t(e){var t=e.dataset,n=t.lazyImg;if(n)return{type:"layzImg",url:n};var r=t.lazyBgd;if(r)return{type:"lazyBgd",url:r};var o=t.lazyPoster;return o?{type:"lazyPoster",url:o}:void 0},setSrc:function(t,e){switch(e.type){case"layzImg":t.src=e.url,t.removeAttribute("data-lazy-img");break;case"lazyBgd":t.style.backgroundImage="url("+e.url+")";break;case"lazyPoster":t.poster=e.url}},webp:function(){var t=void 0;return function(){return new Promise(function(e,n){if(t===!0)return void e(!0);if(t===!1)return void e(!1);var r=new Image;r.onload=function(){Utils.__webp_surport__=t=!0,e(!0),r=null},r.onerror=function(){t=!1,e(!1),r=null},r.src="data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vlAAAA="})}}()},loadImage:function(){var t=this;console.log(Utils.__webp_surport__);var e=Array.from(document.querySelectorAll(".lazy-load-img"));e.length&&e.some(function(e){var n=t.loadImageUtil.data(e),r=n.url;if(r){var o=e.getBoundingClientRect().top,i=e.clientHeight;if(!(o<-i)){if(o>window.innerHeight)return!0;var a=new Image;a.onload=a.onerror=a.onabort=function(){a.onload=a.onerror=a.onabort=null,a=null,t.loadImageUtil.setSrc(e,n)},e.classList.remove("lazy-load-img"),t.loadImageUtil.webp().then(function(o){var i={format:o?"webp":""};a.src=n.url=t.getImageCDNSrc(r,i),(a.width||a.height||a.complete)&&(a.onload=a.onerror=a.onabort=null,a=null,t.loadImageUtil.setSrc(e,n))})}}})},fetch:__fetch,getKey:function(t){return new Promise(function(e){fetch("http://dev.weipaitang.com/manage/getUploadUrl?package="+JSON.stringify(t)).then(function(t){return t.json()}).then(function(t){e(t.requestUrl)})})},upload:function(){var t=this,e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=n.onStart,o=n.onEnd,i=(n.onError,n.onProgress),a=new FormData;Promise.all(Array.from(e).map(function(e){return t.zip(e,1)})).then(function(t){t.forEach(function(t,e){a.append("file"+e,t)}),r&&r(),Utils.fetch("/upload",{method:"POST",body:a,uploadProgress:function(t){i&&i(t)}}).then(function(t){o&&o(t)})})},sort:function(t,e){var n=e.map(function(e){return e+"="+(t[e]||"")}).filter(function(t){return t}).join("&");return n},query:function e(t){t=new URL(t);var n=t.search.slice(1),e={};return n.split("&").map(function(t){var n=t.split("="),r=_slicedToArray(n,2),o=r[0],i=r[1];e[o]=i}),e},zip:function(t){var e=arguments.length<=1||void 0===arguments[1]?.01:arguments[1];HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,n){for(var r=atob(this.toDataURL(e,n).split(",")[1]),o=r.length,i=new Uint8Array(o),a=0;a<o;a++)i[a]=r.charCodeAt(a);t(new Blob([i],{type:e||"image/png"}))}});var n=t.size/1024/1024;return 1!=e&&n>=1.5&&(e=.5),new Promise(function(r,o){if(n<1.5||e>=1||e<=0||!t.type.startsWith("image/"))return r(t);var i=document.createElement("canvas"),a=window.URL.createObjectURL(t),s=document.createElement("img");s.onload=function(){var n=s,o=n.width,a=n.height;i.width=o,i.height=a;var u=i.getContext("2d");u.drawImage(s,0,0,i.width,i.height),s=null,i.toBlob(function(t){r(t)},t.type||"image/jpeg",e)},s.onerror=function(){r(t)},s.src=a})},init:function(){return new Promise(function(t){Utils.loadImageUtil.webp().then(function(e){Utils.scroll.listen("lazy-load-img",Utils.loadImage.bind(Utils)),t("异步执行完")})})}};