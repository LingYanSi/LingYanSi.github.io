"use strict";var __fetch=function(t){var e=function(t,e){return new Promise(function(n,o){var r=new XMLHttpRequest;r.addEventListener("progress",function(t){e.progress&&e.progress(t.loaded/t.total),console.log("progress",t)},!1),r.addEventListener("abort",function(t){o()},!1),r.addEventListener("error",function(t){o()},!1),r.addEventListener("load",function(t){},!1),r.upload.onprogress=function(t){e.uploadProgress&&e.uploadProgress(t.loaded/t.total)},r.open(e.method||"Get",t,!0);var i=e.body;!i instanceof window.FormData&&(i=JSON.stringify(i)),r.addEventListener("readystatechange",function(t){4==r.readyState&&n(r.responseText)}),r.send(i)})};return e.origin=t,e}(window.fetch),Queue=function(t){var e=arguments.length<=1||void 0===arguments[1]?0:arguments[1];this.queue=[],this.fn=t;var n=this;this.tick=function(){this.queue.forEach(clearTimeout),this.queue.push(setTimeout(function(){n.fn()},e))}},Utils={time:{toString:function(t){var e=new Date((+t));return e.getFullYear()+"-"+this.fillZero(e.getMonth()+1)+"-"+this.fillZero(e.getDate())+" "+this.fillZero(e.getHours())+":"+this.fillZero(e.getMinutes())+":"+this.fillZero(e.getSeconds())},fillZero:function(t){return t<10?"0"+t:""+t}},lastPosition:{set:function(t,e){var n=Utils.getSessionStorage("lastPosition");n[t]=e,Utils.setSessionStorage("lastPosition",n)},get:function(t){var e=Utils.getSessionStorage("lastPosition"),n=e[t]||{};return n}},getSessionStorage:function(t){var e=window.sessionStorage.getItem(t)||"{}";try{e=JSON.parse(e)}catch(n){e={}}return e},setSessionStorage:function(t,e){window.sessionStorage.setItem(t,JSON.stringify(e))},scroll:function(){var t={},e=function(){for(var e in t)t[e]&&t[e]()},n=new Queue(e,50);window.addEventListener("scroll",function(){n.tick()});var o={listen:function(e,n){return t[e]=n,{detory:function(){o.remove(e)},key:e}},remove:function(e){delete t[e]},trigger:e,tick:n.tick.bind(n)};return o}(),loadImageUtil:{data:function t(e){var t=e.dataset,n=t.lazyImg;if(n)return{type:"layzImg",url:n};var o=t.lazyBgd;if(o)return{type:"lazyBgd",url:o};var r=t.lazyPoster;return r?{type:"lazyPoster",url:r}:void 0},setSrc:function(t,e){switch(console.log(e.type),e.type){case"layzImg":t.src=e.url;break;case"lazyBgd":t.style.backgroundImage="url("+e.url+")";break;case"lazyPoster":t.poster=e.url}},webp:function(){var t=void 0;return function(){return new Promise(function(e,n){if(t===!0)return void e(!0);if(t===!1)return void e(!1);var o=new Image;o.onload=function(){t=!0,e(!0),o=null},o.onerror=function(){t=!1,e(!1),o=null},o.src="data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vlAAAA="})}}()},loadImage:function(){var t=this,e=Array.from(document.querySelectorAll(".lazy-load-img"));e.length&&e.some(function(e){var n=t.loadImageUtil.data(e),o=n.url;if(o){var r=e.getBoundingClientRect().top,i=e.clientHeight;if(!(r<-i)){if(r>window.innerHeight)return!0;var a=new Image;a.onload=a.onerror=a.onabort=function(){a.onload=a.onerror=a.onabort=null,a=null,t.loadImageUtil.setSrc(e,n)},e.classList.remove("lazy-load-img"),t.loadImageUtil.webp().then(function(r){console.log("是不是支持webp",r),a.src=o,(a.width||a.height||a.complete)&&(a.onload=a.onerror=a.onabort=null,a=null,t.loadImageUtil.setSrc(e,n))})}}})},fetch:__fetch,upload:function(){var t=this,e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],o=n.onStart,r=n.onEnd,i=(n.onError,n.onProgress),a=new FormData;Promise.all(Array.from(e).map(function(e){return t.zip(e,.9)})).then(function(t){t.forEach(function(t,e){a.append("file"+e,t)}),o&&o(),Utils.fetch("/upload",{method:"post",body:a,uploadProgress:function(t){i&&i(t)}}).then(function(t){r&&r(t)})})},zip:function(t){var e=arguments.length<=1||void 0===arguments[1]?.01:arguments[1];return HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,n){for(var o=atob(this.toDataURL(e,n).split(",")[1]),r=o.length,i=new Uint8Array(r),a=0;a<r;a++)i[a]=o.charCodeAt(a);t(new Blob([i],{type:e||"image/png"}))}}),1!=e&&t.size/1024/1024>1.5&&(e=.5),new Promise(function(n,o){if(e>=1||e<=0||!t.type.startsWith("image/"))return n(t);var r=document.createElement("canvas"),i=window.URL.createObjectURL(t),a=document.createElement("img");a.onload=function(){var o=a,i=o.width,l=o.height;r.width=i,r.height=l;var s=r.getContext("2d");s.drawImage(a,0,0,r.width,r.height),a=null,r.toBlob(function(t){n(t)},t.type||"image/jpeg",e)},a.onerror=function(){n(t)},a.src=i})}};Utils.loadImageUtil.webp().then(function(t){Utils.scroll.listen("lazy-load-img",Utils.loadImage.bind(Utils))});